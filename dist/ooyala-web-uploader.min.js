window.Ooyala||(window.Ooyala={}),Ooyala.Client={}||Ooyala.Client,function(e){Ooyala.Client.EventDispatcher=function(){this.eventHandlers={}},e.extend(Ooyala.Client.EventDispatcher.prototype,{on:function(e,t,n){this.eventHandlers[e]||(this.eventHandlers[e]=[]),n=n||this,this.eventHandlers[e].push({handler:t,context:n})},detach:function(e,t){var n=this.eventHandlers[e];if(!n)return;var r=n.length,i=null;for(var s=0;s<r;s++)if(n[s].handler===t){i=s;break}i!=null&&this.eventHandlers[e].splice(i,1)},dispatchEvent:function(e,t){var n=this.eventHandlers[e];if(!n)return;var r=n.length;for(var i=0;i<r;i++){var s=n[i];if(!s)continue;t?s.handler.apply(s.context,t):s.handler.call(s.context)}}})}.call(this,jQuery),function(e){Ooyala.Client.Events={},Ooyala.Client.Events.PROGRESS="progress",Ooyala.Client.Events.COMPLETE="complete",Ooyala.Client.Events.ERROR="error",Ooyala.Client.Events.FILE_SELECTED="fileSelected",Ooyala.Client.Events.ASSET_CREATION_COMPLETE="assetCreationComplete",Ooyala.Client.AssetCreator=function(e,t,n,r){Ooyala.Client.EventDispatcher.call(this);if(typeof jQuery=="undefined")throw new Error("This uploader needs jQuery 1.5+ to be loaded.");if(typeof JSON=="undefined")throw new Error("This uploader depend's on Douglas Crockford's JSON parser (https://github.com/douglascrockford/JSON-js) or one of the following browsers: Internet Explorer 8+, Firefox 3.1+, Safari 4+, Chrome 3+, and Opera 10.5+.");if(!e)throw new Error("Please provide an endpoint URL.");if(!t&&!n)throw new Error("You need to provide either a button element to fire the file browsing action or a file drop area element.");typeof t=="string"&&(t=document.getElementById(t)),this.browseButton=t,this.dropArea=n,this.endpoint=e,this.eventHandlers={},this.options=r||{},this.eventNames=Ooyala.Client.Events,this.uploader=null,this.options.useAspera||(this.uploader=new Ooyala.Client.HTMLUploader(t,r));var i=this;this.uploader.on(this.eventNames.PROGRESS,function(){i.progressHandler()}),this.uploader.on(this.eventNames.COMPLETE,function(){i.uploadCompleteHandler()}),this.uploader.on(this.eventNames.ERROR,function(){i.errorHandler()}),this.uploader.on(this.eventNames.FILE_SELECTED,function(){i.fileSelectedHandler()}),this.browseButton&&this.uploader.assignBrowse(this.browseButton),this.assetToUpload=null,this.embedCode="",this.__asyncOperationsControl=[]},e.extend(Ooyala.Client.AssetCreator.prototype,new Ooyala.Client.EventDispatcher,{fileSelectedHandler:function(){this.dispatchEvent(this.eventNames.FILE_SELECTED)},prepareUpload:function(e,t){var n=this;if(!this.uploader.file){this._errorHandler("The user has not selected a file.");return}var r=this.uploader.file;this.assetToUpload={name:e,description:t},this.options.postProcessingStatus&&(body.postProcessingStatus=this.options.postProcessingStatus),this.createAsset(this.assetToUpload.name,this.assetToUpload.description,r.name,r.size,this.uploader.chunkSize)},upload:function(){var e=this;if(!this.embedCode){this.dispatchEvent(this.eventNames.ERROR,["An asset has not been created."]);return}e.uploader.upload()},progress:function(){return this.uploader?this.uploader.progress():0},progressHandler:function(){this.dispatchEvent(this.eventNames.PROGRESS)},uploadCompleteHandler:function(){var e=this;this._makeAPICall("PUT","assets/"+this.embedCode,{status:"uploaded"},function(){e._completeHandler()})},_notifyAsyncOperation:function(){this.__asyncOperationsControl.push(1)},_asyncOperationCompleted:function(){this.__asyncOperationsControl.pop(),this._completeHandler()},_completeHandler:function(){var e=this;if(this.__asyncOperationsControl.length)return;this.assetToUpload=null,this.embedCode=null,this.dispatchEvent(e.eventNames.COMPLETE,[e.embedCode])},_errorHandler:function(e){this.dispatchEvent(this.eventNames.ERROR,[e])},createAsset:function(e,t,n,r,i,s){var o=this,u={name:e,description:t,file_name:n,file_size:r,chunk_size:i,asset_type:typeof s!="undefined"?s:"video"};this._makeAPICall("POST","assets",u,function(e){o.embedCode=e.embed_code,o.uploader.setUploadingURLs(e.uploading_urls),o.dispatchEvent(o.eventNames.ASSET_CREATION_COMPLETE)})},_makeAPICall:function(t,n,r,i,s,o){o=o||this,s=s||function(e){this._errorHandler(e)},e.ajax({url:this.endpoint+"/"+n,type:t,contentType:"application/json",dataType:"json",data:JSON.stringify(r)}).done(function(e){i.call(o,e)}).fail(function(e){s.call(o,e)})}})}.call(this,jQuery),function(e){Ooyala.Client.Uploader=function(){Ooyala.Client.EventDispatcher.call(this),this.chunk_size=4194304,this.file=null,this.uploadingURLs=[],this.browseButton=null},e.extend(Ooyala.Client.Uploader.prototype,new Ooyala.Client.EventDispatcher,{setUploadingURLs:function(e){this.uploadingURLs=e,this.totalChunks=this.uploadingURLs.length},upload:function(){throw new Error("This method should be implemented by a child object")},progress:function(){return 0},assignBrowse:function(e){this.browseButton=e}})}.call(this,jQuery),function(e){var t=function(){var e=this,t=document.createElement("input");t.type="file",this.browseButton.appendChild(t),t.addEventListener("change",function(n){e.file=t.files[0],e.dispatchEvent("fileSelected")},!1)};Ooyala.Client.HTML5ChunkProvider=function(e,n){Ooyala.Client.EventDispatcher.call(this),this.file=e,this.data="",this.browseButton=n,t.call(this)},e.extend(Ooyala.Client.HTML5ChunkProvider.prototype,new Ooyala.Client.EventDispatcher,{getChunk:function(e,t){if(!this.file)throw new Error("No file has been selected yet.");var n=this,r=this.file.mozSlice?"mozSlice":"slice";this.data=this.file[r](e,t),this.dispatchEvent("complete")}})}.call(this,jQuery),function(e){var t=function(){return typeof File!="undefined"&&(File.prototype.mozSlice||File.prototype.slice||File.prototype.webkitSlice)},n=function(e,t,n){Ooyala.Client.EventDispatcher.call(this),this.url=e,this.chunkProvider=t,this.maxNumberOfRetries=n,this.retriesSoFar=0};e.extend(n.prototype,new Ooyala.Client.EventDispatcher,{upload:function(e){this.retriesSoFar>this.numberOfRetries?this.dispatchEvent("error",[e]):(this.retriesSoFar++,this.transferBytesOverTheWire())},transferBytesOverTheWire:function(){var e=this.url.match(/.+\/(.+)-([^&]+)/),t=parseInt(e[1],10),n=parseInt(e[2],10)+1,r=n-t+1,i=this,s=function(){i.chunkProvider.detach("complete",s);var e=i.chunkProvider.data,t=new XMLHttpRequest;t.addEventListener("load",function(){i.dispatchEvent("complete")}),t.addEventListener("error",function(e){i.upload(e)}),t.open("POST",i.url);if(window.Blob&&document.getElementById("flashChunkProvider")==null){var n=new FormData;n.append("chunk",e),t.send(n)}else{var r="--------------------------"+Math.random().toString().replace("0.",""),o="--"+r+'\r\nContent-Disposition: form-data; name="file"; filename="blob"\r\nContent-Type: application/octet-stream'+(document.getElementById("flashChunkProvider")?"; Content-Transfer-Encoding: base64":"")+"\r\n\r\n"+e+"\r\n--"+r+"--\r\n";t.setRequestHeader("content-type","multipart/form-data; charset=x-user-defined-binary; boundary="+r),t.send(o)}};this.chunkProvider.on("complete",s),this.chunkProvider.getChunk(t,n)}});var r=Ooyala.Client.HTMLUploader=function(n,r){Ooyala.Client.Uploader.call(this),this.chunksUploaded=0,this.chunkProvider=null,this.totalChunks=null,this.currentChunks=[],this.shouldStopBecauseOfError=!1,this.browseButton=n,this.chunkSize=1048576;var i=this,s={maxChunkRetries:3,maxNumberOfConcurrentChunks:1};this.options=e.extend(s,r);if(!t())throw new Error("Your browser does not support HTML5 file APIs.");this.chunkProvider=new Ooyala.Client.HTML5ChunkProvider(this.file,this.browseButton),this.chunkProvider.on("fileSelected",function(){i.file=i.chunkProvider.file,i.dispatchEvent("fileSelected")})};e.extend(Ooyala.Client.HTMLUploader.prototype,new Ooyala.Client.Uploader,{upload:function(){this.totalChunks=this.uploadingURLs.length;for(var e=0;e<this.options.maxNumberOfConcurrentChunks;e++)this.uploadNextChunk()},uploadNextChunk:function(){var e=this,t=this.uploadingURLs.pop();this.dispatchEvent("progress");if(!t){this.dispatchEvent("complete");return}if(this.shouldStopBecauseOfError)return;var r=new n(t,this.chunkProvider,e.options.maxChunkRetries);r.on("complete",function(){e.chunksUploaded++,e.uploadNextChunk()}),r.on("error",function(t){e.dispatchEvent("error",[t]),e.shouldStopBecauseOfError=!0}),r.upload()},progress:function(){return this.chunksUploaded==0?0:this.chunksUploaded/this.totalChunks}})}.call(this,jQuery);